---
title: "Examples"
editor_options: 
  chunk_output_type: console
execute:
  echo: false
  message: false
  warning: false
---

```{r unknown_chunk, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Load Packages

```{r setup, echo = TRUE, output = FALSE, message = FALSE, warning = FALSE}
library(cbssuitabilityhaiti)
library(tidyverse)
library(here)
library(sf)
library(tmap)
library(spData)
library(janitor)
library(devtools)
```

```{r read_adm3, message=FALSE, warning=FALSE, include=FALSE, output=FALSE}
# # get 3rd level administrative areas in Haiti
# # download and unzip maps from stanford data base
# utils::download.file(url = "https://stacks.stanford.edu/file/druid:kz179wf4778/data.zip?download=true",
#               destfile = here::here("vignettes", "articles", "3rd-level-haiti-divisions.zip",
#               mode = "wb")
# unzip(here::here("vignettes", "articles", "3rd-level-haiti-divisions.zip"),
#       exdir = here::here("vignettes", "articles", "haiti-adm3"))
# # remove zip file
# file.remove(here::here("vignettes", "articles", "3rd-level-haiti-divisions.zip")

# read in 3rd administrative lvl spatial files
haiti_adm3 <- st_read(here::here("vignettes", "articles","haiti-adm3","HTI_adm3.shp")) |>
  st_as_sf()

```

## Background

Haiti is a island state in the Caribbean sea. It has four administrative levels where the 3rd level is used to emphasize the data through out this article. The 3rd administrative level contains `r nrow(haiti_adm3)` areas. For this article the extended area around Cap HaÃ¯tien and l'Acul-du-Nord has been explored as depicted in @fig-northern-area.

```{r fig-northern-area, echo=FALSE, message = FALSE, warning = FALSE}
#| label: #fig-northern-area
#| fig-cap: "Map of Haiti showing the 3rd level administration areas that are being investigated (yellow)."
#| fig-cap-location: bottom

### explore Cap-Haitien data
# view(haiti_adm3)

# explore Haiti adm3 area data

tmap_mode("view")

haiti_adm3 |> 
  tm_shape() +
  tmap_options(check.and.fix = TRUE) +
  tm_borders() +
  tm_fill(col = "orange", alpha = 0.6) +
  tm_shape(filter(haiti_adm3, (ID_2 == 24 | ID_2 == 25) & ID_3 != 76 & ID_3 != 80)) +
  tm_borders() +
  tm_fill(col = "yellow", alpha = 0.6)

# find Cap-Haitien data
# mwater |>
#   tabyl(Administra)
# okap |>
#   tabyl(cte)
```

```{r filter-cap, echo = FALSE}
# filter Cap-Haitien adm3 map data
cap_adm3 <- haiti_adm3 |>
  filter(ID_3 == 79) # select Cap-Haitien
cap_adm3 <- haiti_adm3 |>
  filter(ID_3 == 77|ID_3 == 78 | ID_3 == 79 | ID_3 == 81) # select North

# filter Cap-Haitien mwater data
cap_mwater <- mwater |>
  filter(str_detect(administra, "Cap Haitien"))

# filter Cap-Haitien okap data
cap_okap <- okap |>
  filter(cte == "ctecaphaitien")
```

```{r map_adm3_density, echo = FALSE, message = FALSE, warning = FALSE}
#| label: fig-density
#| fig-cap: "Neighborhoods of Cap-Haitien according to their density and different types of sanitation systems in area arround Cap-Haitien"

# basic example plot
# neighborhoods of Cap-Haitien according to their density
# different types of sanitation systems in area arround Cap-Haitien
cap_map <- cap_adm3 |>
  tm_shape() +
  tm_borders(lwd = 2) +
  tm_layout(bg.color = "lightblue") +
  tm_shape(cap_okap) +
  tm_borders() +
  tm_fill(col = "density", palette = "YlOrBr") +
  tm_shape(cap_mwater) +
  tm_dots(col = "type", palette = "Blues")

cap_map
```

```{r map_adm3_economy, echo = FALSE, message = FALSE, warning = FALSE}
#| label: fig-economy
#| fig-cap: "Neighborhoods of Cap-Haitien according to their econimy and different types of sanitation systems in area arround Cap-Haitien"

# basic example plot
# neighborhoods of Cap-Haitien according to their economy
# different types of sanitation systems in area arround Cap-Haitien
cap_adm3 |>
  tm_shape() +
  tm_borders(lwd = 2) +
  tm_layout(bg.color = "lightblue") +
  tm_shape(cap_okap) +
  tm_borders() +
  tm_fill(col = "economy", palette = "YlOrBr") +
  tm_shape(cap_mwater) +
  tm_dots(col = "type", palette = "Blues")
```

```{r join_data, echo=FALSE, message=FALSE, warning=FALSE}
joined_dataset <- st_join(mwater, okap) |> 
  drop_na(neighborho)
```

```{r cap_join_density, echo = FALSE, message = FALSE, warning = FALSE}
okap |>
  st_filter(joined_dataset) |> 
  tm_shape() +
  tm_borders() +
  tm_fill(col = "density", palette = "YlOrBr", alpha = 0.7) +
  tm_shape(joined_dataset) +
  tm_dots(col = "type", palette = "Blues")
```

```{r cap_join_economy, echo=FALSE, message=FALSE, warning=FALSE}
okap |> 
  st_filter(joined_dataset) |> 
  tm_shape() +
  tm_borders() +
  tm_fill(col = "economy", palette = "YlOrBr", alpha = 0.7) +
  tm_shape(joined_dataset) +
  tm_dots(col = "type", palette = "Blues")
```

```{r barplot_simple, echo=FALSE, message=FALSE, warning=FALSE}
joined_dataset |> 
  st_drop_geometry() |> 
  ggplot() +
  geom_bar(aes(y = type))
```

```{r barplot_density, echo=FALSE, message=FALSE, warning=FALSE}
joined_dataset |>
  st_drop_geometry() |> 
  ggplot() +
  geom_bar(aes(y = density, fill = economy), position = "fill") +
  facet_wrap(~ type, nrow = 5)
```

```{r barplot_economy, echo=FALSE, message=FALSE, warning=FALSE}
joined_dataset |> 
  st_drop_geometry() |> 
  ggplot() +
  geom_bar(aes(y = type, fill = density), position = "fill") +
  facet_wrap(~ economy, nrow = 2)
```

## Used datasets

### `okap`

```{r tibble_okap}
as_tibble(okap)
```

### `mwater`

```{r tibble_mwater}
as_tibble(mwater)
```

### Haiti 3rd level administrative areas `haiti_adm3`

```{r tibble_adm3}
as_tibble(haiti_adm3)
```
